Code from Eric Bruneton, http://evasion.inrialpes.fr/~Eric.Bruneton/